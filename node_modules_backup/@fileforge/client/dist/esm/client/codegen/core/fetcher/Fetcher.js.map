{"version":3,"file":"Fetcher.js","sourceRoot":"/","sources":["client/codegen/core/fetcher/Fetcher.ts"],"names":[],"mappings":"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","sourcesContent":["import qs from \"qs\";\nimport { RUNTIME } from \"../runtime\";\nimport { APIResponse } from \"./APIResponse\";\n\nexport type FetchFunction = <R = unknown>(\n  args: Fetcher.Args,\n) => Promise<APIResponse<R, Fetcher.Error>>;\n\nexport declare namespace Fetcher {\n  export interface Args {\n    url: string;\n    method: string;\n    contentType?: string;\n    headers?: Record<string, string | undefined>;\n    queryParameters?: Record<string, string | string[] | object | object[]>;\n    body?: unknown;\n    timeoutMs?: number;\n    maxRetries?: number;\n    withCredentials?: boolean;\n    abortSignal?: AbortSignal;\n    responseType?: \"json\" | \"blob\" | \"streaming\" | \"text\";\n  }\n\n  export type Error =\n    | FailedStatusCodeError\n    | NonJsonError\n    | TimeoutError\n    | UnknownError;\n\n  export interface FailedStatusCodeError {\n    reason: \"status-code\";\n    statusCode: number;\n    body: unknown;\n  }\n\n  export interface NonJsonError {\n    reason: \"non-json\";\n    statusCode: number;\n    rawBody: string;\n  }\n\n  export interface TimeoutError {\n    reason: \"timeout\";\n  }\n\n  export interface UnknownError {\n    reason: \"unknown\";\n    errorMessage: string;\n  }\n}\n\nconst INITIAL_RETRY_DELAY = 1;\nconst MAX_RETRY_DELAY = 60;\nconst DEFAULT_MAX_RETRIES = 2;\n\nasync function fetcherImpl<R = unknown>(\n  args: Fetcher.Args,\n): Promise<APIResponse<R, Fetcher.Error>> {\n  const headers: Record<string, string> = {};\n  if (args.body !== undefined && args.contentType != null) {\n    headers[\"Content-Type\"] = args.contentType;\n  }\n\n  if (args.headers != null) {\n    for (const [key, value] of Object.entries(args.headers)) {\n      if (value != null) {\n        headers[key] = value;\n      }\n    }\n  }\n\n  const url =\n    Object.keys(args.queryParameters ?? {}).length > 0\n      ? `${args.url}?${qs.stringify(args.queryParameters, { arrayFormat: \"repeat\" })}`\n      : args.url;\n\n  let body: BodyInit | undefined = undefined;\n  const maybeStringifyBody = (body: any) => {\n    if (body instanceof Uint8Array) {\n      return body;\n    } else {\n      return JSON.stringify(body);\n    }\n  };\n\n  if (args.body instanceof (await import(\"formdata-node\")).FormData) {\n    body = args.body;\n  } else {\n    try {\n      const Readable = (await import(\"stream\")).Readable;\n\n      if (args.body instanceof Readable) {\n        // @ts-expect-error\n        body = args.body;\n      } else {\n        body = maybeStringifyBody(args.body);\n      }\n    } catch (e) {\n      body = maybeStringifyBody(args.body);\n    }\n  }\n\n  // In Node.js environments, the SDK always uses`node-fetch`.\n  // If not in Node.js the SDK uses global fetch if available,\n  // and falls back to node-fetch.\n  const fetchFn =\n    RUNTIME.type === \"node\"\n      ? // `.default` is required due to this issue:\n        // https://github.com/node-fetch/node-fetch/issues/450#issuecomment-387045223\n        ((await import(\"node-fetch\")).default as any)\n      : typeof fetch == \"function\"\n        ? fetch\n        : ((await import(\"node-fetch\")).default as any);\n\n  const makeRequest = async (): Promise<Response> => {\n    const signals: AbortSignal[] = [];\n\n    // Add timeout signal\n    let timeoutAbortId: NodeJS.Timeout | undefined = undefined;\n    if (args.timeoutMs != null) {\n      const { signal, abortId } = getTimeoutSignal(args.timeoutMs);\n      timeoutAbortId = abortId;\n      signals.push(signal);\n    }\n\n    // Add arbitrary signal\n    if (args.abortSignal != null) {\n      signals.push(args.abortSignal);\n    }\n\n    const response = await fetchFn(url, {\n      method: args.method,\n      headers,\n      body,\n      signal: anySignal(signals),\n      credentials: args.withCredentials ? \"include\" : undefined,\n    });\n\n    if (timeoutAbortId != null) {\n      clearTimeout(timeoutAbortId);\n    }\n\n    return response;\n  };\n\n  try {\n    let response = await makeRequest();\n\n    for (let i = 0; i < (args.maxRetries ?? DEFAULT_MAX_RETRIES); ++i) {\n      if (\n        response.status === 408 ||\n        response.status === 409 ||\n        response.status === 429 ||\n        response.status >= 500\n      ) {\n        const delay = Math.min(\n          INITIAL_RETRY_DELAY * Math.pow(i, 2),\n          MAX_RETRY_DELAY,\n        );\n        await new Promise((resolve) => setTimeout(resolve, delay));\n        response = await makeRequest();\n      } else {\n        break;\n      }\n    }\n\n    let body: unknown;\n    if (response.body != null && args.responseType === \"blob\") {\n      body = await response.blob();\n    } else if (response.body != null && args.responseType === \"streaming\") {\n      body = response.body;\n    } else if (response.body != null && args.responseType === \"text\") {\n      body = await response.text();\n    } else {\n      const text = await response.text();\n      if (text.length > 0) {\n        try {\n          body = JSON.parse(text);\n        } catch (err) {\n          return {\n            ok: false,\n            error: {\n              reason: \"non-json\",\n              statusCode: response.status,\n              rawBody: text,\n            },\n          };\n        }\n      }\n    }\n\n    if (response.status >= 200 && response.status < 400) {\n      return {\n        ok: true,\n        body: body as R,\n        headers: response.headers,\n      };\n    } else {\n      return {\n        ok: false,\n        error: {\n          reason: \"status-code\",\n          statusCode: response.status,\n          body: await response.json(),\n        },\n      };\n    }\n  } catch (error) {\n    if (args.abortSignal != null && args.abortSignal.aborted) {\n      return {\n        ok: false,\n        error: {\n          reason: \"unknown\",\n          errorMessage: \"The user aborted a request\",\n        },\n      };\n    } else if (error instanceof Error && error.name === \"AbortError\") {\n      return {\n        ok: false,\n        error: {\n          reason: \"timeout\",\n        },\n      };\n    } else if (error instanceof Error) {\n      return {\n        ok: false,\n        error: {\n          reason: \"unknown\",\n          errorMessage: error.message,\n        },\n      };\n    }\n\n    return {\n      ok: false,\n      error: {\n        reason: \"unknown\",\n        errorMessage: JSON.stringify(error),\n      },\n    };\n  }\n}\n\nconst TIMEOUT = \"timeout\";\n\nfunction getTimeoutSignal(timeoutMs: number): {\n  signal: AbortSignal;\n  abortId: NodeJS.Timeout;\n} {\n  const controller = new AbortController();\n  const abortId = setTimeout(() => controller.abort(TIMEOUT), timeoutMs);\n  return { signal: controller.signal, abortId };\n}\n\n/**\n * Returns an abort signal that is getting aborted when\n * at least one of the specified abort signals is aborted.\n *\n * Requires at least node.js 18.\n */\nfunction anySignal(...args: AbortSignal[] | [AbortSignal[]]): AbortSignal {\n  // Allowing signals to be passed either as array\n  // of signals or as multiple arguments.\n  const signals = <AbortSignal[]>(\n    (args.length === 1 && Array.isArray(args[0]) ? args[0] : args)\n  );\n\n  const controller = new AbortController();\n\n  for (const signal of signals) {\n    if (signal.aborted) {\n      // Exiting early if one of the signals\n      // is already aborted.\n      controller.abort((signal as any)?.reason);\n      break;\n    }\n\n    // Listening for signals and removing the listeners\n    // when at least one symbol is aborted.\n    signal.addEventListener(\n      \"abort\",\n      () => controller.abort((signal as any)?.reason),\n      {\n        signal: controller.signal,\n      },\n    );\n  }\n\n  return controller.signal;\n}\n\nexport const fetcher: FetchFunction = fetcherImpl;\n"]}